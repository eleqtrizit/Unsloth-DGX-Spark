FROM --platform=linux/amd64 unsloth/unsloth AS unsloth-source

FROM --platform=linux/arm64 nvcr.io/nvidia/pytorch:25.09-py3

# Install uv
RUN pip install uv

# Create virtual environment and install packages
ENV PATH="/opt/venv/bin:$PATH"

# Install JupyterLab and IPython
RUN pip install jupyterlab ipython

# Install required packages with uv pip
RUN pip install transformers peft "datasets==4.3.0" "trl==0.19.1"
RUN pip install --no-deps unsloth unsloth_zoo
RUN pip install hf_transfer
RUN pip install --no-deps bitsandbytes

# Copy workspace files from unsloth container
COPY --from=unsloth-source /workspace /workspace

# Set proper permissions
RUN chmod -R a+rwx /workspace

# Expose ports
EXPOSE 8888 22

# Download test script
RUN curl -O https://raw.githubusercontent.com/NVIDIA/dgx-spark-playbooks/refs/heads/main/nvidia/unsloth/assets/test_unsloth.py

# Start script for JupyterLab
RUN mkdir -p /usr/local/bin && \
    echo '#!/bin/bash' > /usr/local/bin/start-jupyter.sh && \
    echo 'set -e' >> /usr/local/bin/start-jupyter.sh && \
    echo '' >> /usr/local/bin/start-jupyter.sh && \
    echo 'if [ ! -z "$JUPYTER_PASSWORD" ]; then' >> /usr/local/bin/start-jupyter.sh && \
    echo '    HASHED_PASSWORD=$(python -c "from jupyter_server.auth import passwd; print(passwd(\"$JUPYTER_PASSWORD\"))")' >> /usr/local/bin/start-jupyter.sh && \
    echo '    mkdir -p /root/.jupyter' >> /usr/local/bin/start-jupyter.sh && \
    echo '    echo "c.NotebookApp.password = '\''$HASHED_PASSWORD'\''" > /root/.jupyter/jupyter_notebook_config.py' >> /usr/local/bin/start-jupyter.sh && \
    echo '    echo "c.ServerApp.password = '\''$HASHED_PASSWORD'\''" > /root/.jupyter/jupyter_server_config.py' >> /usr/local/bin/start-jupyter.sh && \
    echo 'fi' >> /usr/local/bin/start-jupyter.sh && \
    echo '' >> /usr/local/bin/start-jupyter.sh && \
    echo 'mkdir -p /workspace/work' >> /usr/local/bin/start-jupyter.sh && \
    echo 'cd /workspace' >> /usr/local/bin/start-jupyter.sh && \
    echo 'exec jupyter lab --ip=0.0.0.0 --port=7654 --allow-root --no-browser --ServerApp.token="" --ServerApp.password=""' >> /usr/local/bin/start-jupyter.sh && \
    chmod +x /usr/local/bin/start-jupyter.sh

# Use CMD for default behavior, allowing easy override
# When no command is provided, run the test script
# When bash is requested, run bash
# When start-jupyter.sh is requested, run Jupyter
CMD ["python", "test_unsloth.py"]
